## 二、无人机–服务端交互协议规范

下面给的是一种“适合毕设实现的版本”：**数据负载用 JSON，传输层可以是 HTTP/HTTPS + WebSocket 或 MQTT**。消息结构你可以直接写进附录。

### 1. 通用设计

#### 1.1 通用字段

所有消息建议有统一的 header：

```json
{
  "msgId": "uuid-xxxx",
  "msgType": "Telemetry | SensorData | ImageMeta | Alert | Heartbeat | Command | CommandAck | MissionStatus",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:21:00Z"
}
```

* `msgId`：便于去重和确认；
* `msgType`：区分消息类型；
* `uavId`：无人机唯一标识；
* `timestamp`：ISO8601 UTC 时间。

#### 1.2 方向

* **无人机 → 服务端（上行）**

  * `Heartbeat` 心跳
  * `Telemetry` 遥测
  * `SensorData` 传感器数据（气体、颗粒物等）
  * `ImageMeta` 图像元数据（真实图片通过 HTTP 上传）
  * `MissionStatus` 任务状态
  * `Alert` 异常告警

* **服务端 → 无人机（下行）**

  * `Command`（里面再细分类型）：

    * `StartMission` / `AbortMission` / `PauseMission` / `ResumeMission`
    * `ReturnToHome`（返航）、`Hold`（悬停）
    * `ConfigureSensor`（配置采样频率、开关）
  * `CommandAck` 命令确认

---

### 2. 上行消息定义（无人机 → 服务端）

#### 2.1 Heartbeat（心跳）

**作用**：报告在线并保活。

```json
{
  "msgId": "hb-001",
  "msgType": "Heartbeat",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:21:00Z",
  "body": {
    "firmwareVersion": "1.0.0",
    "softwareVersion": "1.0.3",
    "status": "IDLE"  // IDLE / MISSION / ERROR
  }
}
```

* 建议发送周期：5–10 秒一次。

---

#### 2.2 Telemetry（遥测）

```json
{
  "msgId": "tlm-123",
  "msgType": "Telemetry",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:21:05Z",
  "body": {
    "lat": 23.123456,
    "lng": 113.123456,
    "alt": 120.5,
    "relativeAlt": 100.0,
    "groundSpeed": 12.3,
    "heading": 85.0,
    "battery": 73.5,      // 电量 %
    "linkQuality": 0.92   // 0~1
  }
}
```

---

#### 2.3 MissionStatus（任务状态）

```json
{
  "msgId": "ms-001",
  "msgType": "MissionStatus",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:21:10Z",
  "body": {
    "missionId": "M2025-0001",
    "status": "RUNNING",     // PENDING / RUNNING / COMPLETED / ABORTED / ERROR
    "progress": 0.35,        // 完成进度 0~1
    "currentWaypointIndex": 5,
    "totalWaypoints": 20,
    "remark": ""
  }
}
```

---

#### 2.4 SensorData（标量传感器数据）

可覆盖空气质量、温湿度等所有“数值型”传感器。

```json
{
  "msgId": "sd-001",
  "msgType": "SensorData",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:21:10Z",
  "body": {
    "missionId": "M2025-0002",
    "sensorType": "AIR_QUALITY", // TEMP_HUMID / AIR_QUALITY / GAS / PARTICLE 等
    "position": {
      "lat": 23.123456,
      "lng": 113.123456,
      "alt": 120.5
    },
    "data": {
      "pm25": 45.3,
      "pm10": 70.1,
      "so2": 0.012,
      "no2": 0.023,
      "o3": 0.050
    },
    "samplingRate": 1.0  // Hz
  }
}
```

* 林业健康：可以定义 `sensorType: "MULTISPECTRAL_INDEX"`，`data`里放 NDVI、EVI 等指标（无人机侧先算好一部分，减轻服务端压力）。
* 城市热岛：`sensorType: "THERMAL_POINT"`，`data.temperatureSurface`。

---

#### 2.5 ImageMeta（图像/热成像元数据）

真实图片不建议直接塞进 JSON，走文件上传接口，将文件 URL 或 ID 上报。

```json
{
  "msgId": "img-001",
  "msgType": "ImageMeta",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:21:15Z",
  "body": {
    "missionId": "M2025-0003",
    "imageId": "IMG_20251117_0001",
    "imageType": "THERMAL",   // RGB / MULTISPECTRAL / THERMAL
    "fileUrl": "https://server.example.com/files/IMG_20251117_0001.tiff",
    "position": {
      "lat": 23.123456,
      "lng": 113.123456,
      "alt": 150.0
    },
    "footprint": [
      [23.1231, 113.1231],
      [23.1231, 113.1238],
      [23.1238, 113.1238],
      [23.1238, 113.1231]
    ],
    "extra": {
      "gimbalYaw": 10.0,
      "gimbalPitch": -90.0
    }
  }
}
```

---

#### 2.6 Alert（告警）

```json
{
  "msgId": "alert-001",
  "msgType": "Alert",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:21:20Z",
  "body": {
    "missionId": "M2025-0004",
    "alertType": "FIRE_RISK",  // FIRE_RISK / AIR_POLLUTION / VEGETATION_HEALTH / SYSTEM_ERROR 等
    "level": "HIGH",           // INFO / WARNING / HIGH / CRITICAL
    "position": {
      "lat": 23.123456,
      "lng": 113.123456,
      "alt": 130.0
    },
    "relatedImageId": "IMG_20251117_0002",
    "description": "Thermal hotspot detected, max 120°C in region."
  }
}
```

---

### 3. 下行消息定义（服务端 → 无人机）

统一 `msgType: "Command"`，具体命令用 `commandType` 区分。

#### 3.1 StartMission（下发任务与航线）

```json
{
  "msgId": "cmd-001",
  "msgType": "Command",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:25:00Z",
  "body": {
    "commandType": "StartMission",
    "mission": {
      "missionId": "M2025-0005",
      "missionType": "FOREST_HEALTH",    // FOREST_HEALTH / FIRE_MONITOR / HEAT_ISLAND / AIR_QUALITY / LAND_CHANGE
      "area": {
        "polygon": [
          [23.12, 113.12],
          [23.12, 113.14],
          [23.14, 113.14],
          [23.14, 113.12]
        ]
      },
      "altitude": 150.0,
      "speed": 12.0,
      "waypoints": [
        { "lat": 23.120, "lng": 113.120, "alt": 150 },
        { "lat": 23.120, "lng": 113.140, "alt": 150 }
      ],
      "sensors": [
        {
          "sensorType": "THERMAL",
          "samplingRate": 1.0
        },
        {
          "sensorType": "AIR_QUALITY",
          "samplingRate": 0.5
        }
      ]
    }
  }
}
```

#### 3.2 控制命令（返航/暂停等）

```json
{
  "msgId": "cmd-002",
  "msgType": "Command",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:30:00Z",
  "body": {
    "commandType": "ReturnToHome",
    "params": {}
  }
}
```

```json
{
  "msgId": "cmd-003",
  "msgType": "Command",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:31:00Z",
  "body": {
    "commandType": "ConfigureSensor",
    "params": {
      "sensorType": "AIR_QUALITY",
      "samplingRate": 2.0,
      "enable": true
    }
  }
}
```

#### 3.3 CommandAck（命令确认）

无人机收到命令后的应答：

```json
{
  "msgId": "ack-001",
  "msgType": "CommandAck",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:25:01Z",
  "body": {
    "requestMsgId": "cmd-001",
    "result": "OK",           // OK / FAILED / UNSUPPORTED
    "reason": ""
  }
}
```
---