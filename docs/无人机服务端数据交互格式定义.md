## 二、无人机–服务端交互协议规范

下面给的是一种“适合毕设实现的版本”：**数据负载用 JSON，传输层可以是 HTTP/HTTPS + WebSocket 或 MQTT**。消息结构你可以直接写进附录。

### 1. 通用设计

#### 1.1 通用字段

所有消息建议有统一的 header：

```json
{
  "msgId": "uuid-xxxx",
  "msgType": "Telemetry | SensorData | ImageMeta | Alert | Heartbeat | Command | CommandAck | MissionStatus",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:21:00Z",
  "protocolVersion": "1.0",
  "seq": 1024,
  "authToken": "Bearer xxx",
  "signature": "HMAC-SHA256(payload)",
  "payloadCrc32": "AB12CD34"
}
```

* `msgId`：便于去重和确认；
* `msgType`：区分消息类型；
* `uavId`：无人机唯一标识；
* `timestamp`：ISO8601 UTC 时间；
* `protocolVersion`：协议演进版本号，便于兼容；
* `seq`：单连接递增序号，用于乱序检测、重放保护；
* `authToken` + `signature`：携带认证信息及签名；Plane 侧使用设备密钥计算，服务端验证；
* `payloadCrc32`：可选的传输层完整性校验，配合压缩/加密后检查。

#### 1.2 方向

* **无人机 → 服务端（上行）**

  * `Registration` 设备激活/注册
  * `Heartbeat` 心跳
  * `Telemetry` 遥测
  * `SensorData` 传感器数据（气体、颗粒物等）
  * `ImageMeta` 图像元数据（真实图片通过 HTTP 上传）
  * `MissionStatus` 任务状态
  * `FlightEvent` 飞行事件（起飞、返航、异常）
  * `MissionSummary` 任务总结
  * `Alert` 异常告警
  * `DataChunk` 大文件分片上传（选用）
  * `CommandAck` 命令执行结果 / 拒绝理由（也可归类为上行）

* **服务端 → 无人机（下行）**

  * `Command`（里面再细分类型）：

    * `StartMission` / `AbortMission` / `PauseMission` / `ResumeMission`
    * `ReturnToHome`（返航）、`Hold`（悬停）
    * `ConfigureSensor`（配置采样频率、开关）
    * `SyncTemplate`（同步任务模板/预设阈值）
    * `UploadSchedule`（下发任务执行时间窗）
  * `CommandAck` 命令确认
  * `DataRequest`（请求无人机补传指定数据段）
  * `ConfigUpdate`（固件/黑名单/禁飞区文件版本通知）

#### 1.3 连接、鉴权与可靠性

1. **建立连接**：无人机在开机后先通过 HTTPS POST `/api/uav/register` 完成 `Registration`，拿到短期 `authToken` 与配置；其后使用 MQTT/WebSocket 长连接，保持心跳。
2. **鉴权方式**：基于设备证书或预共享密钥（PSK）；`authToken` 过期后由服务端下发 `Command: RefreshToken` 或要求重新注册。
3. **可靠性策略**：
   * 关键消息（`Telemetry`、`SensorData`、`MissionStatus`、`Command`）均需 ACK。若 5 秒内未收到 ACK，自动重发，重试 3 次后上报 `FlightEvent` 类型为 `LINK_DEGRADED`。
   * 所有消息可选开启 gzip 压缩；`payloadCrc32` 确保压缩后完整性。
   * 数据去重：服务端以 `(uavId, msgId)` 作为幂等键，重复消息返回 `CommandAck` result=`DUPLICATE`。

4. **时间同步**：无人机启动时通过 NTP 或读取服务端在 `Registration` 应答中的 `serverTime`，保证时间戳误差 ≤2 秒。

---

### 2. 上行消息定义（无人机 → 服务端）

#### 2.0 通用负载字段约定

* `missionId`：若当前处于任务上下文必须填写；无任务则可为空或 `null`。
* `position`：统一结构 `{ "lat": xx, "lng": xx, "alt": xx, "relativeAlt": xx }`，其中 `relativeAlt` 可选。
* `qualityFlag`：`"OK" | "WARNING" | "ERROR" | "MISSING"`，用于标识数据质量；如采样点漂移或传感器自检失败时标注。
* `dataId`：建议在传感器/图像类消息中带唯一 ID，便于补传、引用。
* `extensions`：为未来扩展保留的 JSON 对象，前后兼容；未知字段服务端忽略。

#### 2.1 Registration（注册/激活）

**作用**：首次接入或 token 过期后重新获取配置、禁飞区、任务模板版本。

```json
{
  "msgId": "reg-001",
  "msgType": "Registration",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:20:00Z",
  "body": {
    "manufacturer": "DJI",
    "model": "M300",
    "serialNumber": "SN-123456",
    "firmwareVersion": "v02.00.01",
    "supportedSensors": ["THERMAL", "AIR_QUALITY", "MULTISPECTRAL"],
    "communicationModules": ["5G", "4G"],
    "batteryCycles": 213,
    "maxFlightTimeMin": 40,
    "certificateId": "CERT-xxxx"
  }
}
```

**服务端应答**（HTTP 或 `Command: RegistrationAck`）：

```json
{
  "msgType": "RegistrationAck",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:20:01Z",
  "body": {
    "authToken": "Bearer abc",
    "tokenExpireAt": "2025-11-18T03:20:01Z",
    "protocolVersion": "1.0",
    "serverTime": "2025-11-17T03:20:01Z",
    "noFlyZonesVersion": "NFZ-2025-01",
    "missionTemplateVersion": "TMP-2025-01"
  }
}
```

注册完成后再进入心跳/数据上报流程。

#### 2.2 Heartbeat（心跳）

**作用**：报告在线并保活。

```json
{
  "msgId": "hb-001",
  "msgType": "Heartbeat",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:21:00Z",
  "body": {
    "firmwareVersion": "1.0.0",
    "softwareVersion": "1.0.3",
    "status": "IDLE"  // IDLE / MISSION / ERROR
  }
}
```

* 建议发送周期：5–10 秒一次。

---

#### 2.3 Telemetry（遥测）

```json
{
  "msgId": "tlm-123",
  "msgType": "Telemetry",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:21:05Z",
  "body": {
    "lat": 23.123456,
    "lng": 113.123456,
    "alt": 120.5,
    "relativeAlt": 100.0,
    "groundSpeed": 12.3,
    "heading": 85.0,
    "battery": 73.5,      // 电量 %
    "linkQuality": 0.92   // 0~1
  }
}
```

---

#### 2.4 MissionStatus（任务状态）

```json
{
  "msgId": "ms-001",
  "msgType": "MissionStatus",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:21:10Z",
  "body": {
    "missionId": "M2025-0001",
    "status": "RUNNING",     // PENDING / RUNNING / COMPLETED / ABORTED / ERROR
    "progress": 0.35,        // 完成进度 0~1
    "currentWaypointIndex": 5,
    "totalWaypoints": 20,
    "remark": ""
  }
}
```

---

#### 2.5 SensorData（标量传感器数据）

可覆盖空气质量、温湿度等所有“数值型”传感器。

```json
{
  "msgId": "sd-001",
  "msgType": "SensorData",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:21:10Z",
  "body": {
    "missionId": "M2025-0002",
    "sensorType": "AIR_QUALITY", // TEMP_HUMID / AIR_QUALITY / GAS / PARTICLE 等
    "position": {
      "lat": 23.123456,
      "lng": 113.123456,
      "alt": 120.5
    },
    "qualityFlag": "OK",
    "data": {
      "pm25": 45.3,
      "pm10": 70.1,
      "so2": 0.012,
      "no2": 0.023,
      "o3": 0.050
    },
    "samplingRate": 1.0,  // Hz
    "dataId": "SD-20251117-0001",
    "extensions": {
      "rawVoltage": 3.3,
      "calibrationVersion": "AQ-1.2"
    }
  }
}
```

* 林业健康：可以定义 `sensorType: "MULTISPECTRAL_INDEX"`，`data`里放 NDVI、EVI 等指标（无人机侧先算好一部分，减轻服务端压力）。
* 城市热岛：`sensorType: "THERMAL_POINT"`，`data.temperatureSurface`。

---

#### 2.6 ImageMeta（图像/热成像元数据）

真实图片不建议直接塞进 JSON，走文件上传接口，将文件 URL 或 ID 上报。

```json
{
  "msgId": "img-001",
  "msgType": "ImageMeta",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:21:15Z",
  "body": {
    "missionId": "M2025-0003",
    "imageId": "IMG_20251117_0001",
    "imageType": "THERMAL",   // RGB / MULTISPECTRAL / THERMAL
    "fileUrl": "https://server.example.com/files/IMG_20251117_0001.tiff",
    "position": {
      "lat": 23.123456,
      "lng": 113.123456,
      "alt": 150.0
    },
    "footprint": [
      [23.1231, 113.1231],
      [23.1231, 113.1238],
      [23.1238, 113.1238],
      [23.1238, 113.1231]
    ],
    "extra": {
      "gimbalYaw": 10.0,
      "gimbalPitch": -90.0
    },
    "qualityFlag": "OK",
    "processing": {
      "orthoCorrected": true,
      "radiometricCalibrated": false
    },
    "dataId": "IMG-20251117-0001"
  }
}
```

---

#### 2.7 Alert（告警）

```json
{
  "msgId": "alert-001",
  "msgType": "Alert",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:21:20Z",
  "body": {
    "missionId": "M2025-0004",
    "alertType": "FIRE_RISK",  // FIRE_RISK / AIR_POLLUTION / VEGETATION_HEALTH / SYSTEM_ERROR 等
    "level": "HIGH",           // INFO / WARNING / HIGH / CRITICAL
    "position": {
      "lat": 23.123456,
      "lng": 113.123456,
      "alt": 130.0
    },
    "relatedImageId": "IMG_20251117_0002",
    "description": "Thermal hotspot detected, max 120°C in region."
  }
}
```

---

#### 2.8 FlightEvent（飞行事件/异常）

用于记录关键事件节点，便于任务监控与审计。

```json
{
  "msgId": "fe-001",
  "msgType": "FlightEvent",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:21:25Z",
  "body": {
    "missionId": "M2025-0004",
    "eventType": "TAKEOFF | LANDING | LINK_DEGRADED | SENSOR_FAILURE | EMERGENCY_BRAKE",
    "position": { "lat": 23.123, "lng": 113.123, "alt": 10 },
    "detail": "Auto takeoff succeeded",
    "relatedMsgId": "cmd-010"
  }
}
```

#### 2.9 MissionSummary（任务总结）

任务完成后 1 分钟内上报，用于生成任务报告。

```json
{
  "msgId": "msm-001",
  "msgType": "MissionSummary",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T05:00:00Z",
  "body": {
    "missionId": "M2025-0004",
    "totalFlightTimeSec": 3600,
    "totalDistanceKm": 42.5,
    "consumedBatteryPercent": 65,
    "sensorPackets": 1200,
    "imagesCaptured": 240,
    "alertsTriggered": [
      { "alertType": "FIRE_RISK", "count": 2 }
    ],
    "summaryText": "任务正常完成，无异常",
    "dataIntegrity": {
      "expectedPackets": 1205,
      "missingPackets": 5
    }
  }
}
```

#### 2.10 DataChunk（大文件分片上传，可选）

对于多光谱原始立方体或热成像视频，可使用 `DataChunk` 方式通过 MQTT/WebSocket 发送，或直接走对象存储上传。分片消息结构：

```json
{
  "msgId": "chunk-001",
  "msgType": "DataChunk",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:40:00Z",
  "body": {
    "missionId": "M2025-0004",
    "dataId": "CUBE-0001",
    "chunkIndex": 1,
    "totalChunks": 10,
    "contentType": "application/octet-stream",
    "encoding": "base64",
    "payload": "....",
    "compression": "gzip",
    "qualityFlag": "OK"
  }
}
```

服务端消费后返回 `CommandAck`（`result: OK` 或 `NEED_RETRANSMIT chunkIndex`）。

### 3. 下行消息定义（服务端 → 无人机）

统一 `msgType: "Command"`，具体命令用 `commandType` 区分。

#### 3.1 StartMission（下发任务与航线）

```json
{
  "msgId": "cmd-001",
  "msgType": "Command",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:25:00Z",
  "body": {
    "commandType": "StartMission",
    "mission": {
      "missionId": "M2025-0005",
      "missionType": "FOREST_HEALTH",    // FOREST_HEALTH / FIRE_MONITOR / HEAT_ISLAND / AIR_QUALITY / LAND_CHANGE
      "templateId": "TMP-FOREST-V1",
      "priority": "HIGH",
      "scheduleWindow": {
        "start": "2025-11-17T04:00:00Z",
        "end": "2025-11-17T06:00:00Z"
      },
      "area": {
        "polygon": [
          [23.12, 113.12],
          [23.12, 113.14],
          [23.14, 113.14],
          [23.14, 113.12]
        ]
      },
      "altitude": 150.0,
      "speed": 12.0,
      "waypoints": [
        { "lat": 23.120, "lng": 113.120, "alt": 150 },
        { "lat": 23.120, "lng": 113.140, "alt": 150 }
      ],
      "sensors": [
        {
          "sensorType": "THERMAL",
          "samplingRate": 1.0,
          "qualityRequirement": "TEMP_RES<=0.5C"
        },
        {
          "sensorType": "AIR_QUALITY",
          "samplingRate": 0.5,
          "calibration": "AQ-1.2"
        }
      ],
      "expectedOutputs": [
        "THERMAL_GRID",
        "NDVI_LAYER",
        "AIR_PROFILE"
      ]
    }
  }
}
```

#### 3.2 控制命令（返航/暂停等）

```json
{
  "msgId": "cmd-002",
  "msgType": "Command",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:30:00Z",
  "body": {
    "commandType": "ReturnToHome",
    "params": {}
  }
}
```

```json
{
  "msgId": "cmd-003",
  "msgType": "Command",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:31:00Z",
  "body": {
    "commandType": "ConfigureSensor",
    "params": {
      "sensorType": "AIR_QUALITY",
      "samplingRate": 2.0,
      "enable": true
    }
  }
}
```

#### 3.3 CommandAck（命令确认）

无人机收到命令后的应答：

```json
{
  "msgId": "ack-001",
  "msgType": "CommandAck",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T03:25:01Z",
  "body": {
    "requestMsgId": "cmd-001",
    "result": "OK",           // OK / FAILED / UNSUPPORTED
    "reason": "",
    "detail": "Mission accepted, will takeoff at 03:50Z"
  }
}
```
---

#### 3.4 DataRequest（补传数据请求）

用于服务器要求无人机重新发送指定数据段或未完成的 `DataChunk`。

```json
{
  "msgId": "cmd-010",
  "msgType": "Command",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T06:00:00Z",
  "body": {
    "commandType": "DataRequest",
    "params": {
      "missionId": "M2025-0004",
      "dataType": "SensorData",
      "dataIds": ["SD-20251117-0001", "SD-20251117-0002"],
      "timeRange": {
        "start": "2025-11-17T05:10:00Z",
        "end": "2025-11-17T05:12:00Z"
      }
    }
  }
}
```

#### 3.5 ConfigUpdate / SyncTemplate

```json
{
  "msgId": "cmd-011",
  "msgType": "Command",
  "uavId": "UAV-001",
  "timestamp": "2025-11-17T06:05:00Z",
  "body": {
    "commandType": "ConfigUpdate",
    "params": {
      "noFlyZonesVersion": "NFZ-2025-02",
      "downloadUrl": "https://server/files/nfz-2025-02.geojson",
      "checksum": "9f8a...",
      "forceApply": true
    }
  }
}
```

若只同步任务模板/阈值，可设置 `commandType: "SyncTemplate"`，`params.templateVersion`、`params.templates`。

---

### 4. 文件与图像上传规范

1. **HTTP 上传接口**

   * `POST /api/uav/files`
   * Header：`Authorization: Bearer xxx`、`X-UAV-ID: UAV-001`、`Content-Type: multipart/form-data`
   * 表单字段：
     * `file`：实际二进制文件；
     * `fileType`: `RGB | THERMAL | MULTISPECTRAL | VIDEO`;
     * `missionId`、`sensorType`、`captureTime`。
   * 响应：

   ```json
   {
     "fileId": "IMG_20251117_0001",
     "fileUrl": "https://server/files/IMG_20251117_0001.tiff",
     "checksum": "sha256:xxxx"
   }
   ```

   之后无人机在 `ImageMeta` 里引用 `fileId`/`fileUrl`。

2. **断点续传**

   * 大于 200MB 的文件建议通过分片。流程：`POST /api/uav/files/init` 获取 `uploadId` → 多次 `PUT /api/uav/files/chunk?uploadId=xxx&chunkIndex=n` → `POST /api/uav/files/complete`。
   * 每个分片默认 4MB，可依据链路调节。

3. **对象存储直传**

   * 服务端可返回临时 `STS` 凭证，允许无人机直传到对象存储；上传成功后再上报 `ImageMeta`。
   * 直传场景下 `fileUrl` 由无人机侧生成但必须带签名有效期，防止泄露。

---

### 5. 典型交互流程

1. **设备上线**
   1. 无人机上电 → 向 `/register` 发送 `Registration`。
   2. 服务端校验后返回 `RegistrationAck`（含 token、禁飞区、模板版本）。
   3. 无人机建立 MQTT/WebSocket 长连接，开始 `Heartbeat`。

2. **任务下发与执行**
   1. 管理平台创建任务 → 调度服务向无人机推送 `Command: StartMission`。
   2. 无人机返回 `CommandAck (OK)` 并在计划时间内起飞，同时持续发送 `Telemetry`、`MissionStatus`。
   3. 采集过程中按频率发送 `SensorData`、`ImageMeta`；若出现异常，发送 `Alert` 或 `FlightEvent`。
   4. 任务完成后上报 `MissionSummary`，并等待 `DataRequest` 以补齐缺失数据。

3. **告警与应急**
   1. 无人机侧检测到火点 → 立即发送 `Alert (CRITICAL)`，附带 `relatedImageId`。
   2. 平台判定需返航 → 下发 `Command: ReturnToHome`，无人机 `CommandAck` 并执行。
   3. 之后通过 `FlightEvent` 记录返航、降落。

4. **配置同步**
   * 平台发布新禁飞区/任务模板 → 推送 `ConfigUpdate / SyncTemplate`。
   * 无人机下载完成后回 `CommandAck`，如需重启再额外发送 `FlightEvent (REBOOT_REQUIRED)`。
