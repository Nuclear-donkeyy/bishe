# 无人机环境监测平台数据库模型（MySQL 8）

> 目标：支撑 API 接口文档及无人机端交互数据，采用 MySQL 8，所有表使用 InnoDB，字符集 `utf8mb4`，不使用数据库层面的外键约束，但通过字段命名与索引保持逻辑关联。时间字段统一 `TIMESTAMP` 或 `DATETIME`（默认 UTC）。

## 通用设计约定

- 主键：`BIGINT UNSIGNED AUTO_INCREMENT`，字段名 `id`。
- 逻辑关联字段命名：`*_id`（引用其他表主键）、`*_code`（业务编号，如 `mission_code`）。
- 审计字段：`created_at`, `updated_at`, `created_by`, `updated_by`（可选）。
- JSON 数据：使用 `JSON` 类型保存动态指标/配置。
- 索引：根据常用查询条件建立，示例如 `INDEX idx_missions_status (status)`。

## 1. 鉴权与用户

```sql
CREATE TABLE users (
  id              BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  username        VARCHAR(64) NOT NULL UNIQUE,
  password_hash   VARCHAR(255) NOT NULL,
  name            VARCHAR(64) NOT NULL,
  role            ENUM('superadmin','operator') NOT NULL DEFAULT 'operator',
  status          ENUM('active','disabled') NOT NULL DEFAULT 'active',
  last_login_at   DATETIME NULL,
  created_at      DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at      DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE auth_tokens (
  id            BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  user_id       BIGINT UNSIGNED NOT NULL,
  token_hash    CHAR(64) NOT NULL,
  expires_at    DATETIME NOT NULL,
  revoked_at    DATETIME NULL,
  client_ip     VARCHAR(45) NULL,
  user_agent    VARCHAR(255) NULL,
  created_at    DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_tokens_user (user_id),
  INDEX idx_tokens_hash (token_hash)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

## 2. 无人机接入与遥测

```sql
CREATE TABLE uav_devices (
  id                 BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  uav_code           VARCHAR(64) NOT NULL UNIQUE,
  model              VARCHAR(128) NOT NULL,
  pilot_name         VARCHAR(64) NOT NULL,
  status             ENUM('pending_connect','online','warning','critical') NOT NULL DEFAULT 'pending_connect',
  link_quality       ENUM('优','良','弱') NULL,
  battery_percent    TINYINT UNSIGNED NULL,
  range_km           DECIMAL(8,2) NULL,
  rtt_ms             INT UNSIGNED NULL,
  location_lat       DECIMAL(9,6) NULL,
  location_lng       DECIMAL(9,6) NULL,
  location_alt       DECIMAL(8,2) NULL,
  last_heartbeat_at  DATETIME NULL,
  current_mission_id BIGINT UNSIGNED NULL,
  connection_endpoint   VARCHAR(255) NOT NULL,
  connection_protocol   VARCHAR(32) NOT NULL,
  connection_secret     VARCHAR(128) NULL,
  telemetry_topics      JSON NULL,
  mqtt_username         VARCHAR(128) NULL,
  mqtt_password         VARCHAR(255) NULL,
  metadata              JSON NULL,
  created_at            DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at            DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_uav_status (status),
  INDEX idx_uav_mission (current_mission_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE uav_sessions (
  id              BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  uav_id          BIGINT UNSIGNED NOT NULL,
  session_code    CHAR(32) NOT NULL,
  client_id       VARCHAR(128) NULL,
  connected_at    DATETIME NOT NULL,
  disconnected_at DATETIME NULL,
  connection_ip   VARCHAR(45) NULL,
  reason          VARCHAR(255) NULL,
  INDEX idx_sessions_uav (uav_id),
  INDEX idx_sessions_code (session_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE uav_telemetry (
  id            BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  uav_id        BIGINT UNSIGNED NOT NULL,
  session_code  CHAR(32) NULL,
  reported_at   DATETIME NOT NULL,
  battery_percent  TINYINT UNSIGNED NULL,
  range_km      DECIMAL(8,2) NULL,
  location_lat  DECIMAL(9,6) NULL,
  location_lng  DECIMAL(9,6) NULL,
  location_alt  DECIMAL(8,2) NULL,
  velocity_ms   DECIMAL(8,2) NULL,
  payload       JSON NULL,
  raw_message   JSON NULL,
  INDEX idx_telemetry_uav_time (uav_id, reported_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

> 说明：`uav_devices` 保存接入参数及实时状态；`uav_sessions` 记录 MQTT 建链；`uav_telemetry` 存储心跳历史，供 Dashboard、监控与航线校验使用。

## 3. 任务与航线

```sql
CREATE TABLE mission_types (
  id            BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  type_code     VARCHAR(64) NOT NULL UNIQUE,
  display_name  VARCHAR(64) NOT NULL,
  description   VARCHAR(255) NULL,
  recommended_sensors JSON NULL,
  metrics       JSON NULL,
  created_at    DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE missions (
  id             BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  mission_code   VARCHAR(64) NOT NULL UNIQUE,
  name           VARCHAR(128) NOT NULL,
  mission_type   VARCHAR(64) NOT NULL,
  pilot_name     VARCHAR(64) NOT NULL,
  status         ENUM('执行中','排队','完成','异常中止') NOT NULL,
  priority       ENUM('高','中','低') NOT NULL,
  progress       TINYINT UNSIGNED NOT NULL DEFAULT 0,
  color_hex      CHAR(7) NULL,
  metrics        JSON NULL,
  milestones     JSON NULL,
  created_by     BIGINT UNSIGNED NULL,
  created_at     DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at     DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_missions_status (status),
  INDEX idx_missions_type (mission_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE mission_route_points (
  id          BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  mission_id  BIGINT UNSIGNED NOT NULL,
  seq         INT NOT NULL,
  lat         DECIMAL(9,6) NOT NULL,
  lng         DECIMAL(9,6) NOT NULL,
  altitude    DECIMAL(8,2) NULL,
  created_at  DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_route_mission_seq (mission_id, seq)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE mission_uav_assignments (
  id            BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  mission_id    BIGINT UNSIGNED NOT NULL,
  uav_id        BIGINT UNSIGNED NOT NULL,
  assigned_at   DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  released_at   DATETIME NULL,
  role          VARCHAR(32) NULL,
  INDEX idx_assign_mission (mission_id),
  INDEX idx_assign_uav (uav_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE mission_events (
  id            BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  mission_id    BIGINT UNSIGNED NOT NULL,
  event_type    VARCHAR(64) NOT NULL,
  payload       JSON NULL,
  occurred_at   DATETIME NOT NULL,
  INDEX idx_events_mission (mission_id, occurred_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

> 说明：`mission_route_points` 支撑航线闭合规则；`mission_events` 记录进度/中断等事件，驱动 `ws/mission-events`。

## 4. 实时监测任务

```sql
CREATE TABLE monitoring_tasks (
  id              BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  task_code       VARCHAR(64) NOT NULL UNIQUE,
  mission_id      BIGINT UNSIGNED NULL,
  mission_name    VARCHAR(128) NOT NULL,
  mission_type    VARCHAR(64) NOT NULL,
  owner_name      VARCHAR(64) NOT NULL,
  status          ENUM('执行中','计划中','完成') NOT NULL,
  location_desc   VARCHAR(128) NULL,
  devices_count   INT UNSIGNED NOT NULL DEFAULT 0,
  video_url       VARCHAR(255) NULL,
  stream_id       VARCHAR(64) NULL,
  extra_data      JSON NULL,
  created_at      DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at      DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_monitoring_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE monitoring_task_metrics (
  id           BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  task_id      BIGINT UNSIGNED NOT NULL,
  label        VARCHAR(64) NOT NULL,
  value        VARCHAR(64) NOT NULL,
  unit         VARCHAR(16) NULL,
  recorded_at  DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_task_metrics (task_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE monitoring_metric_series (
  id           BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  task_id      BIGINT UNSIGNED NOT NULL,
  metric_key   VARCHAR(64) NOT NULL,
  timestamp    DATETIME NOT NULL,
  value        DECIMAL(12,4) NULL,
  INDEX idx_metric_series (task_id, metric_key, timestamp)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE monitoring_execution_timeline (
  id           BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  task_id      BIGINT UNSIGNED NOT NULL,
  step_label   VARCHAR(64) NOT NULL,
  timestamp    DATETIME NOT NULL,
  value        DECIMAL(10,4) NULL,
  INDEX idx_execution_timeline (task_id, timestamp)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE monitoring_rules (
  id          BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  task_id     BIGINT UNSIGNED NOT NULL,
  name        VARCHAR(128) NOT NULL,
  metric      VARCHAR(64) NOT NULL,
  threshold   VARCHAR(64) NOT NULL,
  level       ENUM('提示','预警','警报') NOT NULL,
  created_at  DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at  DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_rules_task (task_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE monitoring_alerts (
  id          BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  task_id     BIGINT UNSIGNED NOT NULL,
  rule_id     BIGINT UNSIGNED NULL,
  level       ENUM('提示','预警','警报') NOT NULL,
  message     VARCHAR(255) NOT NULL,
  issued_at   DATETIME NOT NULL,
  acknowledged BOOLEAN NOT NULL DEFAULT FALSE,
  acknowledged_at DATETIME NULL,
  INDEX idx_alerts_task (task_id, issued_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

> 说明：`monitoring_task_metrics` 保存前端“关键指标”卡片；`monitoring_metric_series` 用于趋势图；`monitoring_rules` 及 `monitoring_alerts` 支撑规则 CRUD 与告警确认。

## 5. AI 数据分析 / 历史任务结果

```sql
CREATE TABLE analytics_definitions (
  id            BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  mission_type  VARCHAR(64) NOT NULL,
  title         VARCHAR(128) NOT NULL,
  description   VARCHAR(255) NULL,
  series_config JSON NOT NULL,
  display_order INT NOT NULL DEFAULT 0,
  created_at    DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_analytics_type (mission_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE task_executions (
  id            BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  execution_code VARCHAR(64) NOT NULL UNIQUE,
  mission_name   VARCHAR(128) NOT NULL,
  mission_type   VARCHAR(64) NOT NULL,
  location       VARCHAR(128) NULL,
  owner_name     VARCHAR(64) NULL,
  completed_at   DATETIME NOT NULL,
  metrics        JSON NOT NULL,
  created_at     DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_task_exec_type_time (mission_type, completed_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

> 说明：`analytics_definitions` 可配置折线图；`task_executions.metrics` 以 JSON 保存 `max|min|avg|count|value` 等统计。

## 6. 其他支撑表（可选）

- `fleet_summary_cache`：按小时落地 `online`, `warning`, `alerts`, `avg_rtt`，供 Dashboard 快速拉取。
- `video_streams`：记录 WebSocket / WebRTC 流信息（stream_id、uav_id、task_id、codec 等）。
- `system_logs`：服务端日志索引 `request_id`，辅助排查。

## 数据与无人机交互考虑

1. **接入登记**：`uav_devices` 储存端点、协议、密钥等信息；返回给无人机/操作者的 MQTT 用户名、密码存于该表，可配合 `uav_sessions` 校验接入。
2. **实时心跳**：每条 MQTT 消息写入 `uav_telemetry`，并同步更新 `uav_devices` 中的实时字段（电量、位置、航程等）。
3. **航线校验**：`mission_route_points` 可直接供后端计算闭合、距离、总里程；配合 `uav_devices.range_km` 与 `uav_telemetry` 最新位置完成规则校验。
4. **任务-无人机关联**：`mission_uav_assignments` 记录何时分配/释放；虽无外键，但依靠 `mission_id`、`uav_id` 索引查询。
5. **监测与视频**：`monitoring_tasks.stream_id` 映射到 WebSocket 视频通道；`monitoring_metric_series` 和 `uav_telemetry` 可通过 `task_id` 与 `uav_id` 逻辑关联构建实时图表。

该数据模型覆盖了前后端主要场景，同时保留与无人机端交互所需的连接参数、遥测数据与历史追溯能力。根据后续性能需求，可将大体量表（如 `uav_telemetry`、`monitoring_metric_series`）拆分至归档库或时序数据库。
