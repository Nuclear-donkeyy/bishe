## 一、平台需求说明书（缩略版结构）

### 1. 项目概述

**1.1 项目名称**
无人机环境监测数据采集与分析平台

**1.2 建设目标**

* 面向林业、森林火情、城市热岛、空气质量、土地利用变化等空中可监测场景；
* 通过无人机挂载多种传感器（多光谱、热成像、气体/颗粒物、可见光）采集数据；
* 构建一个统一的数据采集与分析平台，实现：

  * 无人机任务管理与航线下发
  * 实时遥测/传感器数据上报与可视化
  * 异常自动识别与告警
  * 历史数据管理与对比分析

**1.3 使用角色**

* 环保局人员：日常监测、预警处置、查看报表；
* 科研人员：分析历史数据、导出数据用于建模和论文；
* 系统运维/管理员：设备接入审核、账号/权限配置、系统监控；
* 第三方合作单位（可选）：通过 API 接收数据用于本地模型训练。

---

### 2. 系统总体功能

可画一个简单模块图（文字描述就行）：

* 无人机接入与协议模块
* 任务与航线管理模块
* 实时监测与预警模块
* 传感器数据管理模块
* 分析与可视化模块
* 用户与权限管理模块
* 系统管理模块

---

### 3. 详细功能需求

#### 3.1 无人机接入与管理模块

* **无人机注册管理**

  * 录入/审核无人机信息：编号、机型、载荷类型（可挂哪些传感器）、通信模块（4G/5G/WiFi）。
  * 管理无人机状态：在线/离线、维护中、禁飞。
  * 记录硬件配置（飞控型号、固件版本、最大航时、最大航高）及证照信息，支持附件上传。
  * 支持审批流程：运营人员录入→技术审核协议兼容性→管理员批准后才能接入。
  * 支持批量导入或 API 注册，避免大量手工操作。

* **在线状态与遥测监控**

  * 实时显示无人机位置（经纬度、高度）、航向、速度、电量、链路质量。
  * 支持在线无人机列表与地图视图联动。
  * 支持状态订阅：按区域/任务筛选无人机，地图上区别高风险状态（低电量、信号弱）。
  * 维护实时连接监控面板：显示心跳延迟、重试次数，异常时推送至运维。

* **无人机–平台协议适配**

  * 支持基于统一协议的心跳、遥测、传感器数据、图像元数据上报。
  * 断线重连与消息重发机制（在协议规范里细化）。
  * 提供 SDK/参考实现，封装鉴权、加密、数据压缩。
  * 兼容 HTTP(S) Pull/Push 与 MQTT/WebSocket，便于不同通信模组接入。

> 和“协议部分”的联系：这里明确平台要“会说什么话”，后面协议规范就是把每一句话定义成消息格式。

---

#### 3.2 任务与航线管理模块

* **任务建模**

  * 支持创建任务：任务类型（林业健康、火情巡查、热岛监测、空气质量剖面、土地变化复拍）。
  * 设置任务区域（在地图上画多边形/折线）、高度、速度、采样周期、使用的传感器组合。
  * 支持任务模板：按场景预置航线策略、传感器配置及预警阈值，快速复用。
  * 任务可设优先级、计划执行时间窗、任务负责人，实现多角色协同。

* **航线规划**

  * 根据任务区域生成航线（栅格扫描、剖面飞行等简单策略）。
  * 将航线与任务一并下发给指定无人机。
  * 支持手动微调航点、禁飞区避让、地形跟随、高度/速度分段配置。
  * 航线版本管理：每次更新航线自动生成版本，可回滚、查看变更记录。

* **任务执行监控**

  * 查看任务进度：未开始、执行中、已完成、异常中止。
  * 支持强制终止、返航、暂停等控制命令。
  * 实时显示任务状态里程碑：起飞、到达作业区、采集完成、返航降落。
  * 异常任务自动推送：进度停滞、电量不足、失联等，支持分派处置人。
  * 任务完成后自动生成简报，包括飞行路径、数据量、告警摘要。

> 和无人机的数据交互关系：
> 任务/航线下发 → 协议里的 `StartMission` / `UploadMission`消息；
> 执行进度 → 协议里的 `MissionStatus` 上报。

---

#### 3.3 实时监测与预警模块

* **实时监测**

  * 多种数据实时显示：遥测、环境传感器数值（温度、湿度、PM、气体）、热成像伪彩图预览、可见光缩略图等。
  * 地图叠加显示：例如在地图瓦片上叠加网格数据（PM2.5、地表温度）。
  * 支持自定义大屏布局：卡片、曲线、仪表、热力层可拖拽组合。
  * 提供原始数据与平滑数据两种视图，方便判断波动是否异常。
  * 关键数据点可打标签（例如采样断点、返航点），后续用于历史回放。

* **预警规则配置**

  * 支持按场景配置阈值：

    * 森林火情：地表温度 > 某值 + 持续时间、视野内烟雾检测概率 > 某值；
    * 空气质量：PM2.5/某气体浓度超标；
    * 林业健康：植被指数NDVI持续低于正常范围。
  * AI 模型结果（如烟雾、火点、病虫害识别）触发预警。(后续补充)
  * 阈值可以分多级（提示/预警/警报），每级定义通知渠道（短信、APP、Webhook）。
  * 可定义组合条件：如“温度 > 60 且湿度 < 30 且电量 > 40”才触发返航建议。

* **告警管理**

  * 告警弹窗、地图标注告警点；
  * 告警记录查询、导出。
  * 告警支持确认/转派/关闭流程，记录处置意见及附件。
  * 每条告警与产生的数据帧、图像建立引用，便于复盘。

> 和协议的联系：
> 无人机侧做初步检测（比如热成像中的温度阈值），可以直接上报 `Alert` 消息；
> 或者原始/半处理数据上报后，平台侧进行二次分析再产生告警。

---

#### 3.4 数据采集与管理模块

* **通用数据模型**

  * 统一定义：遥测数据、标量传感器数据（气体/颗粒物/温湿度）、光学/多光谱/热成像图像数据、任务元数据。
  * 各数据模型包含基本字段（时间、坐标、数据来源、任务ID）以及场景专有字段（NDVI、气体浓度单位、分辨率）。
  * 数据质量标记：有效/缺失/异常，记录异常原因（通讯丢包、设备自检失败等）。
* **数据存储**

  * 结构化数据（遥测、传感器数值）存数据库；
  * 大文件（图像/视频）存文件存储/对象存储，数据库存索引和元数据。
  * 支持冷热数据分层：近3个月在主库，历史数据转冷存储但可按需拉回。
  * 具备数据压缩、去噪、坐标纠偏处理流程。
* **任务数据管理**

  * 按任务、场景、时间、区域检索数据；
  * 支持导出 CSV、GeoJSON、影像打包。
  * 提供数据快照：任务完成后锁定数据版本，保证后续分析可复现。
  * 开放 API/Token，用于科研人员批量下载或自动拉取数据集。

---

#### 3.5 分析与可视化模块

* **林业健康**

  * 基于多光谱数据计算NDVI等指标；
  * 生成植被指数热力图、病害疑似区域图层。
  * 支持多时相对比、差值图、自动生成巡检报告（含变化面积、严重程度）。

* **火情监测**

  * 热成像高温点提取，烟雾识别结果叠加地图；
  * 支持时间轴播放查看火情发展过程。
  * 火点轨迹推演与蔓延预测（简化版：依据风速/风向与历史温度梯度）。

* **城市热岛**

  * 地表温度分布图；
  * 不同时刻温度对比（工作日 vs 周末、昼夜对比）。
  * 与地面气象站数据联动，展示差异图层。

* **空气质量**

  * 垂直剖面曲线（高度 vs 浓度）、平面等值线图或热力图；
  * 多任务、多时间段对比分析。
  * 支持阈值带显示、数据极值自动标注。

* **土地利用变化**

  * 多时相影像对比，变化区域高亮显示。
  * 支持变化类型标注（林地→建设用地等），生成统计报表。
  * 变化结果可导出 GeoPackage，供 GIS 软件进一步处理。

---

#### 3.6 用户与权限管理

* 区分环保局用户与科研用户；
* 设置任务管理权限、告警处置权限、数据导出权限。
* 支持多租户/多区域隔离：不同地区可独立管理设备与数据。
* 登录支持账号密码 + 二次验证码。
* 提供操作审计日志：记录关键操作（下发任务、导出数据、删除数据）及原始参数。
* 角色自定义：可新增“数据标注员”、“模型训练账号”等细分角色。

---

### 4. 技术方案

#### 4.1 总体架构方案

* **分层设计**：前端（Web / 大屏）+ API 网关 + 业务服务层（接入、任务、数据、分析、用户）+ 数据层（OLTP + 时序 + 对象存储）+ AI/分析引擎。
* **技术栈**：
  * 前端：react + TypeScript + Vite，地图使用 Mapbox GL JS（支持多边形绘制、热力图层），实时图表使用 ECharts。
  * 网关与 API：Nginx/Traefik + Spring Cloud Gateway，提供统一鉴权与限流。
  * 业务服务：Spring Boot 3（Java/Kotlin）+ MyBatis/Flyway，实时数据流使用 Spring WebFlux 或 Reactor，背景任务使用 Quartz/Spring Batch。
  * 消息与协议：MQTT Broker（EMQX）接入无人机；Kafka 作为内部事件总线；HTTP/HTTPS + RESTful API 提供对外访问；协议字段参见《无人机服务端数据交互格式定义》。
  * 数据库：PostgreSQL + PostGIS（任务、设备、矢量区域），TimescaleDB/InfluxDB（遥测、传感器时序），MinIO/S3（图像/视频），Redis（缓存/会话），Elasticsearch（日志、告警检索）。
  * AI/分析：Python 服务（FastAPI）调用遥测数据进行指标计算，模型运行在 GPU 节点或云函数。
* **部署与运维**：基于 Kubernetes（单集群多命名空间）部署，CI/CD 使用 GitLab CI 或 GitHub Actions，配合 ArgoCD；监控使用 Prometheus + Grafana，日志接入 Loki/ELK。
* **安全**：统一鉴权采用 OAuth2.1 + JWT，内部服务之间使用 mTLS，数据传输 TLS1.2+，密钥存管使用 HashiCorp Vault/云密钥管理。
* **总体数据流步骤**：
  1. 无人机通过 MQTT/WebSocket 发送消息至接入网关 → 接入服务解析、验签、落 Kafka；
  2. 实时处理服务写入 TimescaleDB/Redis 并推送 WebSocket/Server-Sent Events 给前端；
  3. 任务、告警、分析服务订阅 Kafka 事件，更新 PostgreSQL 状态；
  4. 图像/大文件通过对象存储上传，元数据落库，供分析/展示调用；
  5. 用户操作通过前端→API 网关→对应服务并记录审计日志。

#### 4.2 模块技术方案

##### 4.2.1 无人机接入与管理模块

* **架构组件**：设备接入服务（Device Access Service）、MQTT Broker、设备管理服务（Device Registry Service）、运维监控面板（Ops UI）。
* **数据模型**：
  * `uav_device`（PostgreSQL）：`uav_id`、`serial_number`、`model`、`supported_sensors` (JSONB)、`communication_modules`、`firmware_version`、`status`、`cert_id`、`audit_status`、`attachments`。
  * `uav_connection_snapshot`（Redis/Timescale）：`uav_id`、`last_heartbeat_time`、`rtt`、`retry_count`、`link_quality`。
* **SDK/协议**：提供 C++/Rust/Go 参考 SDK，封装 `Registration`、`Heartbeat`、`Telemetry` 等 JSON 消息；通信层支持 MQTT 3.1.1 over TLS 和 HTTPS 长轮询；签名算法使用 HMAC-SHA256，token 刷新通过 `Command: RefreshToken`。
* **前后端交互**：
  1. 管理员在前端（Vue）填写注册表单→调用 `/api/devices` POST，后端校验并触发审批流程（BPMN/Flowable）。
  2. 审批通过后，服务生成 `uavId`、密钥，展示下载 SDK/配置二维码。
  3. 运维监控页面通过 WebSocket 订阅 `uav_connection_snapshot` 变化，地图联动显示在线状态。
* **实施步骤**：
  1. 部署 MQTT Broker、实现 Device Access Service（Netty/MQTT 客户端）解析协议、验证签名、写 Kafka；
  2. 开发 Device Registry API（Spring Boot + PostgreSQL + Flyway）与审批流程；
  3. 实现运维前端页面（Vue + Ant Design Vue），调用 `/api/devices`、`/api/uav-status`；
  4. 编写 SDK 与示例固件，提供自动化测试（模拟器/仿真器）。

##### 4.2.2 任务与航线管理模块

* **架构组件**：任务服务（Mission Service）、航线规划引擎（Route Planner，可用 Python + Shapely 或 C++ 插件）、指挥调度服务（Dispatch Service）、地图服务（Mapbox/GeoServer）。
* **数据模型**：
  * `mission`：`mission_id`、`mission_type`、`template_id`、`priority`、`schedule_window`、`area_geometry` (PostGIS)、`status`、`assigned_uav_id`、`sensors_config` (JSONB)。
  * `waypoint`：`mission_id`、`index`、`lat`、`lng`、`alt`、`speed`、`actions`。
  * `mission_event`：记录状态迁移、指令操作。
* **SDK/协议**：通过 `Command: StartMission`、`Command: ConfigureSensor` 等消息与无人机同步；航线文件可按 MAVLink Mission 格式或自定义 JSON。对接第三方飞控可使用 MAVSDK。
* **前后端交互**：
  1. 前端地图绘制区域 → 发送 GeoJSON 至 `/api/missions/plan`，后端路由至航线规划引擎返回航点。
  2. 用户确认并提交 → Mission Service 写库并调用 Dispatch Service → Dispatch 下发 `StartMission` 指令（经 MQTT）。
  3. 前端任务详情页通过 Server-Sent Events 订阅 `MissionStatus`，显示进度条、航点动画。
* **实施步骤**：
  1. 建立 PostGIS 数据结构、实现 GeoJSON ↔ WKT 转换；
  2. 开发航线规划算法（栅格扫描/蛇形/剖面），提供 REST 接口；
  3. 实现任务调度逻辑（考虑无人机可用性、电量、区域冲突），与协议服务集成；
  4. 前端完成任务列表、详情、地图编辑器（Mapbox Draw + turf.js 校验）。

##### 4.2.3 实时监测与预警模块

* **架构组件**：实时数据服务（Realtime Hub，WebSocket/SSE）、规则引擎（Rule Engine，Drools 或自研 DSL）、告警服务、通知服务（SMS/Email/Webhook）。
* **数据模型**：
  * `telemetry_stream`（TimescaleDB hypertable）：`timestamp`、`uav_id`、`position`、`battery`、`heading`、`link_quality`。
  * `sensor_stream`：`timestamp`、`uav_id`、`mission_id`、`sensor_type`、`metrics` (JSONB)、`quality_flag`。
  * `alert`：`alert_id`、`mission_id`、`alert_type`、`level`、`position`、`status`、`handler`、`attachments`。
* **SDK/协议**：沿用协议文档中 `Telemetry`、`SensorData`、`Alert` 消息；实时推送给前端使用自建 WebSocket（基于 STOMP）或 Kafka + WebSocket bridge。
* **前后端交互**：
  1. Realtime Hub 接收 Kafka 流 → 写入时序库 → 推送实时 Topic（/topic/telemetry/uavId）。
  2. 前端大屏订阅 Topic，使用 Mapbox + ECharts 展示位置、数据曲线，支持多源叠加。
  3. 规则配置页面通过 REST CRUD 规则（JSON DSL），保存到 Rule Engine；发动规则后 Rule Engine 消费 Kafka 流，触发告警并调用通知服务（对接短信网关或钉钉机器人）。
  4. 告警处置页面调用 `/api/alerts/{id}/ack`、`/api/alerts/{id}/close`，并记录日志。
* **实施步骤**：
  1. 部署 Kafka + Kafka Connect，将 MQTT 数据写入 Kafka；
  2. 开发 Realtime Hub（Spring WebFlux + RSocket/WebSocket）和 Rule Engine（Drools/自定义）；
  3. 完成告警服务（状态机 + 通知渠道插件）；
  4. 前端实现实时大屏、规则配置器、告警工作台。

##### 4.2.4 数据采集与管理模块

* **架构组件**：数据接收服务、ETL/清洗管道（Spark/Flink 或 Airflow 批处理）、数据服务 API、文件存储服务。
* **数据模型**：
  * 标量数据表：`telemetry_stream`、`sensor_stream`（见上）。
  * `image_meta`：`image_id`、`mission_id`、`image_type`、`file_url`、`footprint` (Polygon)、`gimbal`、`processing_flags`、`data_id`。
  * `mission_dataset_snapshot`：`mission_id`、`version`、`snapshot_url`、`created_by`。
* **SDK/协议**：文件上传遵循技术方案第 4 章协议；ETL 输出格式为 Parquet/GeoParquet；对外开放数据 API 提供 OGC API Features/ WFS。
* **前后端交互**：
  1. 前端数据检索调用 `/api/datasets`（支持任务/时间/区域查询）；
  2. 下载触发后端生成临时 URL（S3 presigned URL）；
  3. 科研用户通过 API Token 访问 `/api/export?format=geojson`。
* **实施步骤**：
  1. 设计 TimescaleDB retention policy + 分区策略；对象存储部署 MinIO；
  2. 搭建 ETL（Airflow 调度 + Spark/Flink 作业）进行去噪、坐标纠偏；
  3. 实现数据服务 API（分页/空间索引/导出）与权限控制；
  4. 开发数据快照功能（打包任务相关文件 + 指标表，写入 snapshot 表）。

##### 4.2.5 分析与可视化模块

* **架构组件**：分析计算服务（Python + FastAPI + Rasterio/GDAL）、模型管理服务、可视化服务（Map tile service）、报告生成服务。
* **数据模型**：
  * `analysis_job`：`job_id`、`job_type`、`input_dataset`、`parameters`、`status`、`result_location`。
  * `analysis_layer`：`layer_id`、`layer_type`（NDVI/Heatmap/ChangeDetection）、`source_url`、`time_range`。
  * `report`：`report_id`、`mission_id`、`content_url`、`summary_metrics`。
* **SDK/协议**：分析服务通过 REST/gRPC 接口；瓦片服务采用 XYZ/WMTS；模型加载使用 ONNX Runtime/TensorRT；烟雾识别模型通过 Python SDK 调用。
* **前后端交互**：
  1. 用户勾选任务/时间 → 前端调用 `/api/analysis/jobs` 创建分析任务；
  2. 后端异步执行，完成后写入 `analysis_layer` 并通知前端（WebSocket/通知中心）；
  3. 前端通过 Mapbox `addSource`/`addLayer` 加载瓦片或 GeoJSON；报告生成后以 PDF/HTML 形式提供下载。
* **实施步骤**：
  1. 准备基础模型（NDVI、热岛、火点）并容器化；
  2. 实现分析作业调度（K8s Job + Argo Workflow），配置数据访问（对象存储挂载/STS）；
  3. 建立瓦片化流水线（gdal2tiles 或 TiTiler）；
  4. 前端集成图层控制、时间轴、报告下载组件。

##### 4.2.6 用户与权限管理模块

* **架构组件**：身份认证服务（IAM Service，Keycloak/自研 OAuth2）、权限服务（RBAC/ABAC）、审计日志服务。
* **数据模型**：
  * `tenant`、`user`、`role`、`permission`、`user_role`、`role_permission`；
  * `audit_log`：`log_id`、`user_id`、`action`、`resource`、`payload`、`timestamp`、`ip`。
* **SDK/协议**：前端使用 OpenID Connect (PKCE) 登录，后端校验 JWT；细粒度权限通过自定义 `X-Permissions` header 或注解 + Spring Security；审计日志写入 Elasticsearch。
* **前后端交互**：
  1. 登录跳转至 Keycloak，成功后返回 token，前端存于内存/安全存储；
  2. 每个 API 请求带 Bearer Token，网关验证并透传 `tenantId`；
  3. 权限配置页面调用 `/api/iam/roles`、`/api/iam/policies`。
* **实施步骤**：
  1. 部署 Keycloak/自研 IAM，配置多租户 Realm；
  2. 在 API 网关集成 JWT 校验与租户隔离；
  3. 完成前端权限指令（基于角色隐藏按钮）；
  4. 实现审计日志采集（Spring AOP 切面 + Logstash）。

##### 4.2.7 系统管理与运维模块（可选扩展）

* **内容**：系统参数配置、版本管理、日志/监控、健康检查。
* **技术方案**：
  * 配置中心（Nacos/Spring Cloud Config）统一管理阈值、策略；
  * 日志：EFK/Loki，链路追踪：Jaeger；
  * 自动化扩缩容：Keda + Prometheus 指标；
  * 备份恢复：数据库定期快照，MinIO 版本化存储。

---

#### 4.3 实施路线图（建议）

1. **阶段一（接入 & 基础能力）**：完成设备注册、协议接入、实时遥测可视化、基础任务下发（约 2 个月）。
2. **阶段二（数据管理 & 预警）**：上线数据存储、规则引擎、告警流程、数据导出（约 2 个月）。
3. **阶段三（分析 & 多租户）**：上线分析模型、报告、大屏；完善多租户与审计；打通第三方 API（约 3 个月）。
4. **阶段四（优化 & 运维）**：性能压测、自动化运维、安全加固、双活/容灾。
